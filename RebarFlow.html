<!DOCTYPE html>
<html lang="pt-br">
<!-- 
 * SOFTWARE: RebarFlow 2025 - Legendagem Técnica
 * AUTOR: Eng. José Carlos Barreto Filho
 * COPYRIGHT: © 2025 José Carlos Barreto Filho. Todos os direitos reservados.
-->
<head>
    <meta charset="UTF-8">
    <title>RebarFlow 2025 - Eng. Barreto Filho</title>
    <style>
        :root { --primary: #00bcff; --bg: #0f0f0f; --panel: #1a1a1a; --text: #eee; }
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }
        
        .sidebar { width: 350px; background: var(--panel); border-right: 1px solid #333; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
        .cad-viewport { flex-grow: 1; position: relative; }
        
        h2 { font-size: 1.2rem; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 8px; text-transform: uppercase; margin-bottom: 20px; text-align: center;}
        h3 { font-size: 0.8rem; color: #888; text-transform: uppercase; margin: 15px 0 10px 0; display: flex; align-items: center; gap: 10px; }
        h3::after { content: ""; flex-grow: 1; height: 1px; background: #333; }

        .input-group { margin-bottom: 10px; display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 10px; color: #aaa; font-weight: bold; text-transform: uppercase; }
        input, select, button { padding: 10px; border-radius: 6px; border: 1px solid #333; background: #252525; color: white; font-size: 13px; }
        
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { cursor: pointer; font-weight: bold; border: none; transition: 0.2s; }
        .btn-main { background: #007bff; margin-top: 10px; }
        .btn-dist { background: #6f42c1; margin-top: 10px; }
        .btn-main:hover, .btn-dist:hover { filter: brightness(1.2); transform: translateY(-1px); }

        .stats-box { margin-top: 20px; padding: 15px; background: #111; border-radius: 8px; border-left: 5px solid #00ff00; }
        .stats-val { font-family: 'Consolas', monospace; font-size: 18px; color: #00ff00; }

        .footer { margin-top: auto; padding-top: 20px; font-size: 9px; color: #444; text-align: center; line-height: 1.5; }
        canvas { display: block; }
    </style>
</head>
<body>

<aside class="sidebar">
    <h2>RebarFlow 2025</h2>
    
    <!-- Armadura Longitudinal -->
    <h3>Barra Longitudinal</h3>
    <div class="row">
        <div class="input-group">
            <label>Quantidade</label>
            <input type="number" id="longQtd" value="2">
        </div>
        <div class="input-group">
            <label>Nº Posição (N)</label>
            <input type="number" id="longN" value="1">
        </div>
    </div>
    <div class="input-group">
        <label>Comprimento Reto (m)</label>
        <input type="number" id="longComp" step="0.01" value="2.45">
    </div>
    <div class="row">
        <div class="input-group">
            <label>Gancho (cm)</label>
            <input type="number" id="longGancho" value="10">
        </div>
        <div class="input-group">
            <label>Bitola (Ø)</label>
            <select id="longBitola">
                <option value="8.0" data-peso="0.395">8.0 mm</option>
                <option value="10.0" data-peso="0.617" selected>10.0 mm</option>
                <option value="12.5" data-peso="0.963">12.5 mm</option>
                <option value="16.0" data-peso="1.578">16.0 mm</option>
            </select>
        </div>
    </div>
    <button class="btn-main" onclick="addLongitudinal()">+ Adicionar Barra</button>

    <!-- Armadura Distribuição -->
    <h3>Distribuição / Laje</h3>
    <div class="row">
        <div class="input-group">
            <label>Nº Posição (N)</label>
            <input type="number" id="distN" value="2">
        </div>
        <div class="input-group">
            <label>Bitola (Ø)</label>
            <select id="distBitola">
                <option value="5.0" data-peso="0.154">5.0 mm</option>
                <option value="6.3" data-peso="0.245" selected>6.3 mm</option>
                <option value="8.0" data-peso="0.395">8.0 mm</option>
            </select>
        </div>
    </div>
    <div class="input-group">
        <label>Comp. da Barra (m)</label>
        <input type="number" id="distLargura" step="0.01" value="1.00">
    </div>
    <div class="row">
        <div class="input-group">
            <label>Extensão (m)</label>
            <input type="number" id="distExtensao" step="0.01" value="2.00">
        </div>
        <div class="input-group">
            <label>Espaçamento (cm)</label>
            <input type="number" id="distEspac" value="20">
        </div>
    </div>
    <button class="btn-dist" onclick="addDistribuicao()">+ Gerar Distribuição</button>

    <div class="stats-box">
        <div style="font-size: 10px; color: #666; text-transform: uppercase;">Resumo do Aço</div>
        <div class="stats-val"><span id="totalM">0.00</span> m</div>
        <div class="stats-val" style="font-size: 14px; margin-top: 5px;"><span id="totalKg">0.00</span> kg</div>
    </div>

    <button style="background: #dc3545; margin-top: 10px;" onclick="limpar()">Limpar Projeto</button>
    <button style="background: #28a745; margin-top: 5px;" onclick="exportarDXF()">Exportar DXF</button>

    <div class="footer">
        © 2025 ENG. JOSÉ CARLOS BARRETO FILHO<br>TODOS OS DIREITOS RESERVADOS
    </div>
</aside>

<main class="cad-viewport" id="viewport">
    <canvas id="cadCanvas"></canvas>
</main>

<script>
    const canvas = document.getElementById('cadCanvas');
    const ctx = canvas.getContext('2d');
    const viewport = document.getElementById('viewport');
    const ESCALA = 80; 
    let armaduras = [];

    function redimensionar() {
        canvas.width = viewport.clientWidth;
        canvas.height = viewport.clientHeight;
        renderizar();
    }

    function addLongitudinal() {
        const q = parseInt(document.getElementById('longQtd').value);
        const n = document.getElementById('longN').value;
        const c = parseFloat(document.getElementById('longComp').value);
        const g = (parseFloat(document.getElementById('longGancho').value) || 0) / 100;
        const opt = document.getElementById('longBitola').options[document.getElementById('longBitola').selectedIndex];
        
        const yPos = 120 + (armaduras.length * 110);
        const xMid = canvas.width / 2;
        const cTotalCm = Math.round((c + (2 * g)) * 100);

        armaduras.push({
            tipo: 'barra',
            qtd: q, n: n,
            x1: xMid - (c*ESCALA/2), y1: yPos, x2: xMid + (c*ESCALA/2), y2: yPos,
            c, g, bitola: opt.value, pesoLin: parseFloat(opt.dataset.peso), 
            totalM: (c + (2*g)) * q, legenda: `${q} N${n} ∅${opt.value} C=${cTotalCm}`
        });
        posProcessamento();
        document.getElementById('longN').value = parseInt(n) + 1; // Incremento automático
    }

    function addDistribuicao() {
        const n = document.getElementById('distN').value;
        const largura = parseFloat(document.getElementById('distLargura').value);
        const extensao = parseFloat(document.getElementById('distExtensao').value);
        const espac = parseFloat(document.getElementById('distEspac').value) / 100;
        const opt = document.getElementById('distBitola').options[document.getElementById('distBitola').selectedIndex];

        const q = Math.floor(extensao / espac) + 1;
        const yBase = 120 + (armaduras.length * 110);
        const xMid = canvas.width / 2;
        const cTotalCm = Math.round(largura * 100);

        armaduras.push({
            tipo: 'distribuicao',
            qtd: q, n: n,
            xMid, yBase, largura, extensao, espac,
            bitola: opt.value, pesoLin: parseFloat(opt.dataset.peso), 
            totalM: largura * q, legenda: `${q} N${n} ∅${opt.value} C=${cTotalCm}`
        });
        posProcessamento();
        document.getElementById('distN').value = parseInt(n) + 1;
    }

    function posProcessamento() {
        let tm = 0, tk = 0;
        armaduras.forEach(a => {
            tm += a.totalM;
            tk += a.totalM * a.pesoLin;
        });
        document.getElementById('totalM').innerText = tm.toFixed(2);
        document.getElementById('totalKg').innerText = tk.toFixed(2);
        renderizar();
    }

    function renderizar() {
        ctx.fillStyle = "#0f0f0f"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        armaduras.forEach((a) => {
            ctx.strokeStyle = (a.tipo === 'barra') ? "#ff6b1a" : "#00bcff";
            ctx.lineWidth = Math.max(3, a.bitola / 3);
            
            if(a.tipo === 'barra') {
                const gp = a.g * ESCALA;
                ctx.beginPath();
                ctx.moveTo(a.x1, a.y1 - gp); ctx.lineTo(a.x1, a.y1);
                ctx.lineTo(a.x2, a.y2); ctx.lineTo(a.x2, a.y2 - gp);
                ctx.stroke();
                
                ctx.fillStyle = "#fff";
                ctx.font = "bold 14px Arial";
                ctx.textAlign = "center";
                ctx.fillText(a.legenda, (a.x1 + a.x2)/2, a.y1 - gp - 15);
            } else {
                for(let i=0; i < a.qtd; i++) {
                    const y = a.yBase + (i * a.espac * 15); // Espaçamento visual reduzido para caber mais
                    const x1 = a.xMid - (a.largura*ESCALA/2);
                    const x2 = a.xMid + (a.largura*ESCALA/2);
                    ctx.globalAlpha = 0.4;
                    ctx.beginPath(); ctx.moveTo(x1, y); ctx.lineTo(x2, y); ctx.stroke();
                    ctx.globalAlpha = 1.0;
                }
                ctx.fillStyle = "#00bcff";
                ctx.font = "bold 14px Arial";
                ctx.textAlign = "center";
                ctx.fillText(a.legenda, a.xMid, a.yBase - 15);
            }
        });
    }

    function exportarDXF() {
        let dxf = "0\nSECTION\n2\nENTITIES\n";
        armaduras.forEach(a => {
            if(a.tipo === 'barra') {
                dxf += lineDXF(a.x1, a.y1, a.x1, a.y1+a.g, a.bitola);
                dxf += lineDXF(a.x1, a.y1, a.x2, a.y2, a.bitola);
                dxf += lineDXF(a.x2, a.y2, a.x2, a.y2+a.g, a.bitola);
            } else {
                for(let i=0; i<a.qtd; i++) {
                    const y = a.yBase + (i*a.espac*ESCALA);
                    dxf += lineDXF(a.xMid-(a.largura*ESCALA/2), y, a.xMid+(a.largura*ESCALA/2), y, a.bitola);
                }
            }
        });
        dxf += "0\nENDSEC\n0\nEOF";
        const link = document.createElement('a');
        link.href = URL.createObjectURL(new Blob([dxf], {type:'application/dxf'}));
        link.download = `RebarFlow_Barreto_2025.dxf`; link.click();
    }

    function lineDXF(x1,y1,x2,y2, b) {
        return `0\nLINE\n8\n${b}mm\n10\n${(x1/ESCALA).toFixed(3)}\n20\n${(y1/ESCALA).toFixed(3)}\n11\n${(x2/ESCALA).toFixed(3)}\n21\n${(y2/ESCALA).toFixed(3)}\n`;
    }

    function limpar() { 
        if(confirm("Deseja limpar todo o projeto?")) {
            armaduras = []; 
            document.getElementById('longN').value = 1;
            document.getElementById('distN').value = 2;
            posProcessamento();
        }
    }
    window.addEventListener('resize', redimensionar);
    redimensionar();
</script>
</body>
</html>
