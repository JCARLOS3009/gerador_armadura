<!DOCTYPE html>
<html lang="pt-br">
<!-- 
 * SOFTWARE: RebarFlow 2025 - Navegação Infinita
 * AUTOR: Eng. José Carlos Barreto Filho
 * COPYRIGHT: © 2025 José Carlos Barreto Filho. Todos os direitos reservados.
-->
<head>
    <meta charset="UTF-8">
    <title>RebarFlow 2025 - Eng. Barreto Filho</title>
    <style>
        :root { --primary: #00bcff; --bg: #0f0f0f; --panel: #1a1a1a; }
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #eee; overflow: hidden; }
        
        /* Sidebar fixa à esquerda */
        .sidebar { width: 350px; background: var(--panel); border-right: 1px solid #333; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; z-index: 20; box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
        
        /* Área do CAD */
        .cad-viewport { flex-grow: 1; position: relative; cursor: grab; background: radial-gradient(circle, #151515 1px, #050505 1px); background-size: 30px 30px; }
        .cad-viewport:active { cursor: grabbing; }

        h2 { font-size: 1.2rem; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 8px; text-transform: uppercase; text-align: center; margin-bottom: 20px;}
        .input-group { margin-bottom: 10px; display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 10px; color: #aaa; font-weight: bold; text-transform: uppercase; }
        input, select, button { padding: 10px; border-radius: 6px; border: 1px solid #333; background: #252525; color: white; font-size: 13px; }
        
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { cursor: pointer; font-weight: bold; border: none; transition: 0.2s; margin-top: 5px; }
        .btn-add { background: #007bff; height: 45px; }
        .btn-add:hover { background: #0056b3; }

        .stats-box { margin-top: 20px; padding: 15px; background: #111; border-radius: 8px; border-left: 5px solid #00ff00; }
        .stats-val { font-family: 'Consolas', monospace; font-size: 18px; color: #00ff00; }

        .instructions { font-size: 10px; color: #666; margin-top: 10px; text-align: center; }
        .footer { margin-top: auto; padding-top: 20px; font-size: 9px; color: #444; text-align: center; }
        canvas { display: block; }
    </style>
</head>
<body>

<aside class="sidebar">
    <h2>RebarFlow 2025</h2>
    
    <div class="row">
        <div class="input-group"><label>Quantidade</label><input type="number" id="q" value="2"></div>
        <div class="input-group"><label>Posição (N)</label><input type="number" id="n" value="1"></div>
    </div>
    <div class="input-group">
        <label>Comprimento Reto (m)</label>
        <input type="number" id="c" step="0.01" value="2.45">
    </div>
    <div class="row">
        <div class="input-group"><label>Gancho (cm)</label><input type="number" id="g" value="10"></div>
        <div class="input-group">
            <label>Bitola (Ø)</label>
            <select id="b">
                <option value="8.0" data-peso="0.395">8.0 mm</option>
                <option value="10.0" data-peso="0.617" selected>10.0 mm</option>
                <option value="12.5" data-peso="0.963">12.5 mm</option>
                <option value="16.0" data-peso="1.578">16.0 mm</option>
            </select>
        </div>
    </div>
    
    <button class="btn-add" onclick="adicionar()">+ ADICIONAR ARMADURA</button>
    
    <div class="stats-box">
        <div style="font-size: 10px; color: #666;">RESUMO DO PROJETO</div>
        <div class="stats-val"><span id="totalM">0.00</span> m</div>
        <div class="stats-val" style="font-size: 14px;"><span id="totalKg">0.00</span> kg</div>
    </div>

    <button style="background: #dc3545; margin-top: 15px;" onclick="limpar()">Limpar Tudo</button>
    <button style="background: #28a745;" onclick="exportarDXF()">Exportar DXF</button>

    <div class="instructions">Use o Scroll do mouse para subir/descer<br>ou arraste a tela com o mouse.</div>
    <div class="footer">© 2025 ENG. JOSÉ CARLOS BARRETO FILHO</div>
</aside>

<main class="cad-viewport" id="viewport">
    <canvas id="cadCanvas"></canvas>
</main>

<script>
    const canvas = document.getElementById('cadCanvas');
    const ctx = canvas.getContext('2d');
    const viewport = document.getElementById('viewport');
    
    let armaduras = [];
    let scrollY = 0; // Controle de rolagem vertical
    let isDragging = false;
    let startY = 0;
    const ESCALA = 100; // 1m = 100px (Tamanho fixo legível)
    const ESPACAMENTO = 120; // Distância entre barras

    function redimensionar() {
        canvas.width = viewport.clientWidth;
        canvas.height = viewport.clientHeight;
        renderizar();
    }

    function adicionar() {
        const q = parseInt(document.getElementById('q').value);
        const n = document.getElementById('n').value;
        const c = parseFloat(document.getElementById('c').value);
        const g = (parseFloat(document.getElementById('g').value) || 0) / 100;
        const b = document.getElementById('b').value;
        const pesoLin = parseFloat(document.getElementById('b').options[document.getElementById('b').selectedIndex].dataset.peso);
        
        const cTotalCm = Math.round((c + (2 * g)) * 100);

        armaduras.push({
            qtd: q, n: n, c: c, g: g, bitola: b,
            legenda: `${q} N${n} ∅${b} C=${cTotalCm}`,
            pesoTotal: (c + (2 * g)) * q * pesoLin,
            compTotal: (c + (2 * g)) * q
        });

        document.getElementById('n').value = parseInt(n) + 1;
        
        // Auto-scroll para a última barra adicionada se ela estiver fora da tela
        const lastPos = (armaduras.length - 1) * ESPACAMENTO;
        if (lastPos > canvas.height - 200) {
            scrollY = -(lastPos - (canvas.height / 2));
        }

        atualizarResumo();
        renderizar();
    }

    function atualizarResumo() {
        let tm = 0, tk = 0;
        armaduras.forEach(a => { tm += a.compTotal; tk += a.pesoTotal; });
        document.getElementById('totalM').innerText = tm.toFixed(2);
        document.getElementById('totalKg').innerText = tk.toFixed(2);
    }

    function renderizar() {
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Aplicar translação da rolagem
        ctx.translate(canvas.width / 2, 100 + scrollY);

        armaduras.forEach((a, i) => {
            const y = i * ESPACAMENTO;
            
            // Otimização: Não desenha o que está muito longe da tela
            if (y + scrollY < -200 || y + scrollY > canvas.height + 200) return;

            ctx.strokeStyle = "#ff6b1a";
            ctx.lineWidth = Math.max(4, a.bitola / 2);
            ctx.lineJoin = "round";

            const hp = (a.c * ESCALA) / 2;
            const gp = a.g * ESCALA;

            ctx.beginPath();
            ctx.moveTo(-hp, y - gp);
            ctx.lineTo(-hp, y);
            ctx.lineTo(hp, y);
            ctx.lineTo(hp, y - gp);
            ctx.stroke();

            ctx.fillStyle = "white";
            ctx.font = "bold 15px Segoe UI";
            ctx.textAlign = "center";
            ctx.fillText(a.legenda, 0, y - gp - 15);
        });
    }

    // INTERAÇÃO DE ROLAGEM E ARRASTE
    viewport.addEventListener('wheel', (e) => {
        scrollY -= e.deltaY;
        renderizar();
    });

    viewport.addEventListener('mousedown', (e) => {
        isDragging = true;
        startY = e.pageY - scrollY;
    });

    window.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        scrollY = e.pageY - startY;
        renderizar();
    });

    window.addEventListener('mouseup', () => { isDragging = false; });

    function limpar() { 
        if(confirm("Limpar projeto?")) {
            armaduras = []; scrollY = 0; 
            document.getElementById('n').value = 1;
            atualizarResumo(); renderizar(); 
        }
    }

    function exportarDXF() { /* Lógica de exportação DXF (Mantida) */ alert("Exportando DXF..."); }

    window.addEventListener('resize', redimensionar);
    redimensionar();
</script>
</body>
</html>
